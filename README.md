# 思源笔记文档差异比较插件

这是一个为思源笔记开发的文档内容差异比较插件，可以比较两个文档的内容差异，类似于GitHub的diff视图。

## 功能特性

- ✅ **智能菜单显示**：只有在文档树中选中两个文档时，右键菜单才会显示"比较文档差异"选项
- ✅ **获取文档内容**：自动获取文档标题和markdown内容
- ✅ **高级差异算法**：使用改进的Myers算法计算文档差异，提供准确的行级比较
- ✅ **GitHub风格界面**：类似GitHub的diff视图，清晰显示新增、删除和修改的内容
- ✅ **统计信息**：显示新增行数、删除行数等统计信息
- ✅ **国际化支持**：支持中文和英文界面
- ✅ **响应式设计**：适配不同屏幕尺寸，支持横向滚动

## 使用方法

1. **选择文档**：在思源笔记的文档树中，按住Ctrl键选中两个要比较的文档
2. **打开菜单**：右键点击选中的文档，会看到"比较文档差异"选项
3. **查看差异**：点击菜单项，插件会自动获取文档内容并显示差异比较结果

## 差异视图说明

- **绿色背景**：表示新增的内容（在第二个文档中新增）
- **红色背景**：表示删除的内容（在第一个文档中存在，第二个文档中删除）
- **白色背景**：表示相同的内容（两个文档中都存在且相同）
- **行号**：左侧显示原文档行号，右侧显示新文档行号
- **统计信息**：顶部显示总的新增和删除行数

## 技术实现

### 核心文件

1. **src/index.ts** - 主插件类
   - 监听文档树菜单事件
   - 处理文档选择逻辑
   - 调用API获取文档内容
   - 显示差异比较对话框

2. **src/utils/diffUtils.ts** - 差异比较工具类
   - 实现Myers算法的最长公共子序列计算
   - 生成行级差异数据
   - 生成HTML差异视图
   - 计算统计信息

3. **public/i18n/** - 国际化文件
   - zh_CN.json：中文界面文本
   - en_US.json：英文界面文本

### 关键API使用

```typescript
// 监听文档树菜单事件
this.eventBus.on("open-menu-doctree", this.handleDocTreeMenu.bind(this));

// 获取文档ID
const docId = element.getAttribute("data-node-id");

// 获取文档标题
const titleResult = await getBlockKramdown(docId);

// 获取文档markdown内容
const contentResult = await exportMdContent(docId);
```

### 差异算法

插件使用改进的Myers算法来计算两个文档的差异：

1. **最长公共子序列（LCS）**：找出两个文档中相同的行
2. **差异计算**：基于LCS结果，标识新增、删除和相同的行
3. **HTML生成**：将差异数据转换为带样式的HTML显示

## 样式特性

- **等宽字体**：使用Monaco、Menlo等编程字体，确保对齐
- **行号显示**：左右两列行号，清晰标识原文档和新文档的行位置
- **颜色区分**：
  - 新增行：浅绿色背景 (#e6ffed)
  - 删除行：浅红色背景 (#ffeef0)
  - 相同行：白色背景
- **悬停效果**：鼠标悬停时行背景略微变暗
- **粘性头部**：文件信息头部固定在顶部，滚动时保持可见

## 扩展功能

插件设计为可扩展的架构，未来可以添加：

- 字符级差异比较
- 忽略空白字符选项
- 导出差异报告
- 批量文档比较
- 差异合并功能

## 兼容性

- 支持思源笔记最新版本
- 兼容桌面端和移动端
- 支持所有markdown格式的文档

## 安装说明

1. 将插件文件复制到思源笔记的插件目录
2. 重启思源笔记或在设置中启用插件
3. 在文档树中选择两个文档即可使用

## 注意事项

- 只有选中恰好两个文档时，菜单选项才会出现
- 大文档比较可能需要一些时间，请耐心等待
- 差异比较基于行级别，不支持字符级精确比较
- 建议比较结构相似的文档以获得最佳效果